<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>DialFi - Reset Password</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="/style.css" />
        <style>
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background-color: var(--background-dark);
            }
            .reset-container {
                background-color: var(--card-background);
                padding: 40px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
                width: 100%;
                max-width: 450px;
                text-align: center;
            }
            .reset-container h2 {
                color: var(--secondary-color);
                margin-bottom: 30px;
                font-size: 2em;
            }
            .reset-container label {
                display: block;
                text-align: left;
                margin-bottom: 8px;
                color: var(--text-color-primary);
                font-weight: 600;
            }
            .reset-container input[type="password"] {
                width: calc(100% - 30px);
                padding: 15px;
                margin-bottom: 20px;
                border: 1px solid #444;
                border-radius: 8px;
                font-size: 1em;
                background-color: var(--background-light);
                color: var(--text-color-primary);
                box-sizing: border-box;
            }
            .reset-container .btn {
                width: 100%;
                margin-top: 10px;
            }
            .reset-container .small-text {
                margin-top: 20px;
                font-size: 0.9em;
                color: var(--text-color-secondary);
            }
            .reset-container .small-text a {
                color: var(--secondary-color);
                text-decoration: none;
                transition: color 0.3s ease;
            }
            .reset-container .small-text a:hover {
                color: var(--accent-color);
            }
            .loading-spinner { /* Added loading spinner style */
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-left-color: var(--primary-color);
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
                margin: 20px auto;
                display: none; /* Hidden by default */
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <div id="messageBox" class="message-box" style="display: none">
            <p id="messageText"></p>
        </div>

        <div class="reset-container">
            <h2>Reset Your Password</h2>
            <p id="resetMessage">Enter your new password below.</p>

            <div class="input-group">
                <label for="new-password">New Password:</label>
                <input
                    type="password"
                    id="new-password"
                    placeholder="Enter new password"
                    minlength="6"
                />
            </div>

            <div class="input-group">
                <label for="confirm-password">Confirm New Password:</label>
                <input
                    type="password"
                    id="confirm-password"
                    placeholder="Confirm new password"
                    minlength="6"
                />
            </div>

            <div class="loading-spinner" id="loadingSpinner"></div> <!-- Added loading spinner -->

            <button class="btn primary-btn" id="resetPasswordBtn">
                Reset Password
            </button>

            <button class="btn secondary-btn" id="goToLoginBtn" style="display: none;">
                Go to Login
            </button>

            <p class="small-text" id="loginLinkText">
                Remembered your password? <a href="/login.html">Login here</a>
            </p>
        </div>

        <script src="/shared.js"></script>
        <script type="module"> // Ensure type="module" for modern JS
            document.addEventListener("DOMContentLoaded", async () => {
                const newPasswordInput = document.getElementById("new-password");
                const confirmPasswordInput = document.getElementById("confirm-password");
                const resetPasswordBtn = document.getElementById("resetPasswordBtn");
                const resetMessage = document.getElementById("resetMessage");
                const goToLoginBtn = document.getElementById("goToLoginBtn");
                const loginLinkText = document.getElementById("loginLinkText");
                const loadingSpinner = document.getElementById("loadingSpinner");

                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token'); // Extract token from query parameter


                if (!token) {
                    showMessage("Error: No reset token found in URL.", true);
                    resetMessage.textContent = "Password reset failed: Invalid link. No token found.";
                    resetPasswordBtn.style.display = "none";
                    newPasswordInput.style.display = "none";
                    confirmPasswordInput.style.display = "none";
                    loginLinkText.style.display = "none";
                    goToLoginBtn.style.display = "block";
                    return;
                }

                resetPasswordBtn.addEventListener("click", async () => {
                    const newPassword = newPasswordInput.value.trim();
                    const confirmPassword = confirmPasswordInput.value.trim();

                    if (!newPassword || !confirmPassword) {
                        showMessage(
                            "Please fill in both password fields.",
                            true,
                        );
                        return;
                    }

                    if (newPassword.length < 6) {
                        showMessage(
                            "New password must be at least 6 characters long.",
                            true,
                        );
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        showMessage("Passwords do not match.", true);
                        return;
                    }

                    showMessage("Resetting password...", false);
                    loadingSpinner.style.display = "block"; // Show spinner
                    resetPasswordBtn.disabled = true; // Disable button

                    try {
                        const data = await apiCall(
                            `/auth/reset-password/${token}`,
                            "PUT",
                            { password: newPassword },
                            false, // No auth token required for reset password endpoint
                        );

                        showMessage(
                            data.message ||
                                "Password reset successfully! Please log in.",
                            false,
                        );
                        resetMessage.textContent = "Your password has been reset successfully! You can now log in.";
                        newPasswordInput.style.display = "none";
                        confirmPasswordInput.style.display = "none";
                        resetPasswordBtn.style.display = "none";
                        loginLinkText.style.display = "none"; // Hide old login link
                        goToLoginBtn.style.display = "block"; // Show new login button

                    } catch (error) {
                        console.error("Password reset error:", error);
                        const errorMessage =
                            (error.response && error.response.message) ||
                            error.message ||
                            "Failed to reset password. Link may be invalid or expired.";
                        showMessage(errorMessage, true);
                        resetMessage.textContent = errorMessage;
                        // If the error indicates invalid/expired token, show login button
                        if (error.response && error.response.message && (error.response.message.includes("Invalid") || error.response.message.includes("expired"))) {
                            goToLoginBtn.style.display = "block";
                            loginLinkText.style.display = "none"; // Ensure old link is hidden
                        }
                    } finally {
                        loadingSpinner.style.display = "none"; // Hide spinner
                        resetPasswordBtn.disabled = false; // Re-enable button (if not hidden)
                    }
                });

                goToLoginBtn.addEventListener("click", () => {
                    window.location.href = "/login.html"; // Redirect to your login page
                });
            });
        </script>
    </body>
</html>
