<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>DialFi - Reset Password</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
            rel="stylesheet"
        />
        <!-- IMPORTANT: Use absolute path -->
        <link rel="stylesheet" href="/style.css" />
        <style>
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background-color: var(--background-dark);
            }
            .reset-container {
                background-color: var(--card-background);
                padding: 40px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
                width: 100%;
                max-width: 450px;
                text-align: center;
            }
            .reset-container h2 {
                color: var(--secondary-color);
                margin-bottom: 30px;
                font-size: 2em;
            }
            .reset-container label {
                display: block;
                text-align: left;
                margin-bottom: 8px;
                color: var(--text-color-primary);
                font-weight: 600;
            }
            .reset-container input[type="password"] {
                width: calc(100% - 30px);
                padding: 15px;
                margin-bottom: 20px;
                border: 1px solid #444;
                border-radius: 8px;
                font-size: 1em;
                background-color: var(--background-light);
                color: var(--text-color-primary);
                box-sizing: border-box;
            }
            .reset-container .btn {
                width: 100%;
                margin-top: 10px;
            }
            .reset-container .small-text {
                margin-top: 20px;
                font-size: 0.9em;
                color: var(--text-color-secondary);
            }
            .reset-container .small-text a {
                color: var(--secondary-color);
                text-decoration: none;
                transition: color 0.3s ease;
            }
            .reset-container .small-text a:hover {
                color: var(--accent-color);
            }
        </style>
    </head>
    <body>
        <div class="reset-container">
            <div id="messageBox" class="message-box" style="display: none">
                <p id="messageText"></p>
            </div>
            <h2>Reset Your Password</h2>
            <p>Enter your new password below.</p>

            <label for="new-password">New Password:</label>
            <input
                type="password"
                id="new-password"
                placeholder="Enter new password"
            />

            <label for="confirm-password">Confirm New Password:</label>
            <input
                type="password"
                id="confirm-password"
                placeholder="Confirm new password"
            />

            <button class="btn primary-btn" id="resetPasswordBtn">
                Reset Password
            </button>

            <p class="small-text">
                Remembered your password? <a href="/login.html">Login here</a>
            </p>
        </div>

        <!-- IMPORTANT: Use absolute path -->
        <script src="/shared.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                const newPasswordInput =
                    document.getElementById("new-password");
                const confirmPasswordInput =
                    document.getElementById("confirm-password");
                const resetPasswordBtn =
                    document.getElementById("resetPasswordBtn");

                const urlPath = window.location.pathname;
                const token = urlPath.split("/").pop(); // Extracts the token from /reset-password/:token

                if (!token) {
                    showMessage("Error: No reset token found in URL.", true);
                    return;
                }

                resetPasswordBtn.addEventListener("click", async () => {
                    const newPassword = newPasswordInput.value.trim();
                    const confirmPassword = confirmPasswordInput.value.trim();

                    if (!newPassword || !confirmPassword) {
                        showMessage(
                            "Please fill in both password fields.",
                            true,
                        );
                        return;
                    }

                    if (newPassword.length < 6) {
                        showMessage(
                            "New password must be at least 6 characters long.",
                            true,
                        );
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        showMessage("Passwords do not match.", true);
                        return;
                    }

                    try {
                        showMessage("Resetting password...", false);
                        const data = await apiCall(
                            `/auth/reset-password/${token}`,
                            "PUT",
                            { password: newPassword },
                            false, // No auth token required for reset password endpoint
                        );

                        showMessage(
                            data.message ||
                                "Password reset successfully! Please log in.",
                            false,
                        );
                        // Redirect to login page after successful reset
                        setTimeout(() => {
                            window.location.href = "/login.html"; // Use absolute path
                        }, 2000);
                    } catch (error) {
                        console.error("Password reset error:", error);
                        const errorMessage =
                            (error.response && error.response.message) ||
                            "Failed to reset password. Link may be invalid or expired.";
                        showMessage(errorMessage, true);
                    }
                });
            });
        </script>
    </body>
</html>
